<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SvakiSto Data Editor</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    [x-cloak] {
      display: none !important;
    }

    .drag-over {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
  </style>
</head>

<body class="bg-gray-100 text-slate-800 h-screen flex flex-col" x-data="dataEditor()">

  <!-- Loading Overlay -->
  <div x-show="isLoading" style="display: none;"
    class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm"
    x-transition.opacity.duration.200ms>
    <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center gap-4 text-center max-w-sm w-full mx-4">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
      <div>
        <h3 class="font-bold text-xl text-gray-800 mb-1">Processing Data</h3>
        <p class="text-slate-500 text-sm animate-pulse" x-text="loadingDetails || 'Please wait...'"></p>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between shadow-sm z-10">
    <div class="flex items-center gap-3">
      <i data-lucide="database" class="text-blue-600"></i>
      <h1 class="font-bold text-xl">SvakiSto Data Editor</h1>
    </div>
    <div class="flex gap-3">
      <button @click="exportData()"
        class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition shadow">
        <i data-lucide="download" class="w-4 h-4"></i>
        Export JSON
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- Sidebar: Import & Sources -->
    <aside class="w-80 bg-white border-r border-gray-200 flex flex-col overflow-y-auto">
      <div class="p-4 border-b border-gray-100">
        <h2 class="font-semibold text-gray-500 text-sm uppercase tracking-wider mb-3">Import Backups</h2>

        <!-- Drop Zone -->
        <div
          class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer transition hover:border-blue-400 hover:bg-gray-50"
          :class="{ 'drag-over': isDragging }" @dragover.prevent="isDragging = true"
          @dragleave.prevent="isDragging = false" @drop.prevent="handleDrop($event)" @click="$refs.fileInput.click()">
          <input type="file" x-ref="fileInput" multiple accept=".json" class="hidden"
            @change="handleFiles($event.target.files)">
          <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
          <p class="text-sm text-gray-600">Drop files here or click to upload</p>
        </div>
      </div>

      <div class="p-4 flex-1">
        <h2 class="font-semibold text-gray-500 text-sm uppercase tracking-wider mb-2">Loaded Sources</h2>
        <div class="space-y-2">
          <template x-for="(file, index) in loadedFiles" :key="index">
            <div
              class="group flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm border border-gray-100">
              <div class="flex items-center gap-2 overflow-hidden">
                <i data-lucide="file-json" class="w-4 h-4 text-orange-500 shrink-0"></i>
                <span class="truncate" x-text="file.name"></span>
              </div>
              <span class="text-xs text-gray-400" x-text="file.stats"></span>
            </div>
          </template>
          <div x-show="loadedFiles.length === 0" class="text-xs text-gray-400 italic text-center py-4">
            No files loaded yet.
          </div>
        </div>
      </div>

      <div class="p-4 border-t border-gray-100 flex-1 overflow-y-auto">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold text-gray-500 text-sm uppercase tracking-wider">Groups</h2>
          <div class="flex gap-1">
            <button @click="addClient()" class="p-1 hover:bg-gray-100 rounded text-green-600" title="Add Client">
              <i data-lucide="building" class="w-4 h-4"></i>
            </button>
            <button @click="addGroup()" class="p-1 hover:bg-gray-100 rounded text-blue-600" title="Add Group">
              <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
        <div class="space-y-2">
          <template x-for="group in masterData.groups" :key="group.id">
            <div
              class="group flex items-center justify-between p-2 bg-white border border-gray-200 rounded-lg text-sm shadow-sm">
              <div class="flex items-center gap-2 overflow-hidden">
                <button class="w-3 h-3 rounded-full cursor-pointer hover:scale-110 transition-transform shrink-0"
                  :class="`bg-${group.color || 'blue'}-500`" @click="cycleGroupColor(group)"
                  title="Change Color"></button>

                <template x-if="editingId === `group-${group.id}`">
                  <input type="text" x-model="editName" @keydown.enter="saveRename('group', group.id)"
                    @click.outside="cancelRename()" x-init="$el.focus()"
                    class="px-1 py-0.5 border rounded text-xs w-full">
                </template>
                <template x-if="editingId !== `group-${group.id}`">
                  <span class="truncate" x-text="group.name"
                    @dblclick="startRename('group', group.id, group.name)"></span>
                </template>
              </div>
              <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button @click.stop="startRename('group', group.id, group.name)"
                  class="text-gray-400 hover:text-blue-500">
                  <i data-lucide="edit-2" class="w-3 h-3"></i>
                </button>
                <button @click="deleteItem('group', group.id)" class="text-gray-400 hover:text-red-500">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                </button>
              </div>
            </div>
          </template>
          <div x-show="masterData.groups.length === 0" class="text-xs text-gray-400 italic text-center py-2">
            No groups defined.
          </div>
        </div>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50">
        <div class="flex justify-between text-xs text-gray-500 mb-1">
          <span>Total Clients:</span>
          <span class="font-bold" x-text="masterData.clients.length"></span>
        </div>
        <div class="flex justify-between text-xs text-gray-500">
          <span>Total Stations:</span>
          <span class="font-bold" x-text="masterData.stations.length"></span>
        </div>
      </div>
    </aside>

    <!-- Main Content: Hierarchy Tree -->
    <main class="flex-1 bg-gray-50 p-6 overflow-y-auto" x-ref="mainScroll">
      <div class="w-full max-w-[1920px] mx-auto">
        <div class="flex items-center justify-between mb-6">
          <h2 class="font-bold text-2xl text-gray-800">Organization Structure</h2>
          <div class="flex gap-2">
            <button @click="expandAll()"
              class="px-3 py-1.5 bg-white border border-gray-200 rounded text-xs font-medium hover:bg-gray-50 text-gray-600">
              Expand All
            </button>
            <button @click="collapseAll()"
              class="px-3 py-1.5 bg-white border border-gray-200 rounded text-xs font-medium hover:bg-gray-50 text-gray-600">
              Collapse All
            </button>
          </div>
        </div>

        <div class="space-y-4">
          <template x-for="client in sortedClients" :key="client.id">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
              <!-- Client Header (Sticky) -->
              <div
                class="sticky top-0 z-20 bg-gray-50 rounded-t-xl px-4 py-3 border-b border-gray-100 flex items-center justify-between group shadow-sm transition-shadow"
                :class="{ 'border-b-0': isCollapsed('client', client.id), 'rounded-b-xl': isCollapsed('client', client.id) }"
                @click="toggleCollapse('client', client.id)">
                <div class="flex items-center gap-3 cursor-pointer select-none">
                  <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform duration-200"
                    :class="{ '-rotate-90': isCollapsed('client', client.id) }"></i>
                  <i data-lucide="building" class="w-5 h-5 text-blue-600"></i>

                  <template x-if="editingId === `client-${client.id}`">
                    <input type="text" x-model="editName" @keydown.enter="saveRename('client', client.id)"
                      @click.outside="cancelRename()" @click.stop x-init="$el.focus()"
                      class="px-2 py-1 border rounded text-sm">
                  </template>
                  <template x-if="editingId !== `client-${client.id}`">
                    <div class="flex items-center gap-3">
                      <h3 class="font-bold text-lg text-gray-800" x-text="client.name"
                        @dblclick.stop="startRename('client', client.id, client.name)"></h3>

                      <!-- Group Select -->
                      <select
                        class="text-xs border border-gray-200 rounded px-2 py-1 bg-white text-gray-600 focus:border-blue-500 outline-none"
                        x-model.number="client.groupId" @change="updateClientGroup(client.id, $event.target.value)"
                        @click.stop>
                        <option value="-1">Uncategorized</option>
                        <template x-for="g in masterData.groups" :key="g.id">
                          <option :value="g.id" x-text="g.name" :selected="client.groupId === g.id"></option>
                        </template>
                      </select>
                    </div>
                  </template>
                </div>
                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button @click.stop="startRename('client', client.id, client.name)"
                    class="p-1 hover:bg-gray-200 rounded text-gray-500"><i data-lucide="edit-2"
                      class="w-4 h-4"></i></button>
                  <button @click.stop="deleteItem('client', client.id)"
                    class="p-1 hover:bg-red-100 text-red-500 rounded"><i data-lucide="trash-2"
                      class="w-4 h-4"></i></button>
                </div>
              </div>

              <!-- Objects & Stations -->
              <div class="p-4 space-y-4" x-show="!isCollapsed('client', client.id)" x-transition>
                <template x-for="obj in getClientObjects(client.id)" :key="obj.id">
                  <div class="pl-0 md:pl-4 border-l-0 md:border-l-2 border-gray-100">
                    <!-- Object Header -->
                    <div class="flex items-center justify-between mb-2 group cursor-pointer"
                      @click="toggleCollapse('object', obj.id)">
                      <div class="flex items-center gap-2 select-none">
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transition-transform duration-200"
                          :class="{ '-rotate-90': isCollapsed('object', obj.id) }"></i>
                        <i data-lucide="box" class="w-4 h-4 text-purple-500"></i>

                        <template x-if="editingId === `object-${obj.id}`">
                          <input type="text" x-model="editName" @keydown.enter="saveRename('object', obj.id)"
                            @click.outside="cancelRename()" @click.stop x-init="$el.focus()"
                            class="px-2 py-1 border rounded text-sm">
                        </template>
                        <template x-if="editingId !== `object-${obj.id}`">
                          <span class="font-medium text-gray-700" x-text="obj.name"
                            @dblclick.stop="startRename('object', obj.id, obj.name)"></span>
                        </template>
                      </div>
                      <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button @click.stop="startRename('object', obj.id, obj.name)"
                          class="p-1 hover:bg-gray-200 rounded text-gray-400"><i data-lucide="edit-2"
                            class="w-3 h-3"></i></button>
                        <button @click.stop="deleteItem('object', obj.id)"
                          class="p-1 hover:bg-red-100 text-red-400 rounded"><i data-lucide="trash-2"
                            class="w-3 h-3"></i></button>
                      </div>
                    </div>

                    <!-- Stations Grid -->
                    <div
                      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3"
                      x-show="!isCollapsed('object', obj.id)" x-transition>
                      <template x-for="station in getObjectStations(obj.id)" :key="station.id">
                        <div
                          class="group relative bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition cursor-grab active:cursor-grabbing flex flex-col gap-1"
                          draggable="true" @dragstart="dragStart($event, station)">
                          <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2">
                              <i data-lucide="monitor" class="w-4 h-4 text-slate-400"></i>

                              <template x-if="editingId === `station-${station.id}`">
                                <input type="text" x-model="editName" @keydown.enter="saveRename('station', station.id)"
                                  @click.outside="cancelRename()" x-init="$el.focus()"
                                  class="w-full px-1 py-0.5 border rounded text-xs">
                              </template>
                              <template x-if="editingId !== `station-${station.id}`">
                                <span class="font-medium text-sm text-gray-800 truncate" x-text="station.name"
                                  @dblclick="startRename('station', station.id, station.name)"></span>
                              </template>
                            </div>

                            <!-- Move Handler (Select) -->
                            <select
                              class="opacity-0 group-hover:opacity-100 absolute top-2 right-2 w-4 h-4 text-[0px] bg-transparent cursor-pointer"
                              @change="moveStation(station.id, $event.target.value)" title="Move to...">
                              <option disabled selected>Move to...</option>
                              <template x-for="targetClient in masterData.clients" :key="targetClient.id">
                                <optgroup :label="targetClient.name">
                                  <template x-for="targetObj in getClientObjects(targetClient.id)" :key="targetObj.id">
                                    <option :value="targetObj.id" x-text="targetObj.name"
                                      :disabled="targetObj.id === station.objectId"></option>
                                  </template>
                                </optgroup>
                              </template>
                            </select>
                            <i data-lucide="move"
                              class="absolute top-3 right-3 w-3 h-3 text-gray-400 opacity-0 group-hover:opacity-100 pointer-events-none"></i>
                          </div>

                          <div class="text-xs text-gray-500 font-mono" x-text="station.anydeskId"></div>

                          <!-- Actions Footer -->
                          <div
                            class="mt-2 pt-2 border-t border-gray-50 flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button @click.stop="startRename('station', station.id, station.name)"
                              class="text-gray-400 hover:text-blue-500"><i data-lucide="edit-2"
                                class="w-3 h-3"></i></button>
                            <button @click="deleteItem('station', station.id)"
                              class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2"
                                class="w-3 h-3"></i></button>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
    </main>
  </div>

  <script>
    function dataEditor() {
      return {
        isDragging: false,
        loadedFiles: [],
        masterData: {
          meta: {
            date: new Date().toISOString(),
            version: "1.1.0",
            exportedBy: "SvakiStoEditor"
          },
          clients: [],
          groups: [],
          objects: [],
          stations: []
        },

        // Editing State
        editingId: null,
        editName: "",

        // UI State
        collapsed: new Set(),
        isLoading: false,
        loadingDetails: "",

        init() {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          this.$watch('masterData', () => {
            this.$nextTick(() => {
              if (typeof lucide !== 'undefined') lucide.createIcons();
            });
          });
        },

        // --- UI Helpers ---
        toggleCollapse(type, id) {
          const key = `${type}-${id}`;
          if (this.collapsed.has(key)) {
            this.collapsed.delete(key);
          } else {
            this.collapsed.add(key);
          }
          this.collapsed = new Set(this.collapsed);
        },

        isCollapsed(type, id) {
          return this.collapsed.has(`${type}-${id}`);
        },

        expandAll() {
          this.collapsed = new Set();
        },

        collapseAll() {
          const newSet = new Set();
          this.masterData.clients.forEach(c => newSet.add(`client-${c.id}`));
          this.masterData.objects.forEach(o => newSet.add(`object-${o.id}`));
          this.collapsed = newSet;
        },

        get sortedClients() {
          return this.masterData.clients.sort((a, b) => a.name.localeCompare(b.name));
        },

        getClientObjects(clientId) {
          return this.masterData.objects.filter(o => o.clientId === clientId).sort((a, b) => a.name.localeCompare(b.name));
        },

        getObjectStations(objectId) {
          return this.masterData.stations.filter(s => s.objectId === objectId).sort((a, b) => a.name.localeCompare(b.name));
        },

        // --- File Handling ---
        handleDrop(e) {
          this.isDragging = false;
          this.handleFiles(e.dataTransfer.files);
        },

        async handleFiles(files) {
          this.isLoading = true;
          this.loadingDetails = `Preparing ${files.length} file(s)...`;

          await new Promise(resolve => setTimeout(resolve, 50));

          for (let file of files) {
            try {
              this.loadingDetails = `Reading ${file.name}...`;
              await new Promise(resolve => setTimeout(resolve, 10));

              const text = await file.text();

              this.loadingDetails = `Parsing ${file.name}...`;
              await new Promise(resolve => setTimeout(resolve, 10));

              const json = JSON.parse(text);

              if (json.encrypted) {
                alert(`Skipping encrypted file: ${file.name}. Please Decrypt first inside the App main settings.`);
                continue;
              }

              this.loadingDetails = `Merging data from ${file.name}...`;
              await new Promise(resolve => setTimeout(resolve, 10));

              this.mergeData(json);

              this.loadedFiles.push({
                name: file.name,
                stats: `${json.stations?.length || 0} Stations`
              });

            } catch (err) {
              console.error("Error parsing file", file.name, err);
              alert(`Error parsing ${file.name}: Invalid JSON`);
            }
          }

          this.loadingDetails = "Finalizing...";
          await new Promise(resolve => setTimeout(resolve, 300));
          this.isLoading = false;
        },

        mergeData(newData) {
          // 0. Groups
          const groupMap = {};
          if (newData.groups) {
            newData.groups.forEach(newGroup => {
              const existingGroup = this.masterData.groups.find(g => g.name.trim().toLowerCase() === newGroup.name.trim().toLowerCase());
              if (existingGroup) {
                groupMap[newGroup.id] = existingGroup.id;
              } else {
                const newId = this.generateId(this.masterData.groups);
                groupMap[newGroup.id] = newId;
                this.masterData.groups.push({ ...newGroup, id: newId });
              }
            });
          }

          // 1. Clients
          const clientMap = {};
          newData.clients.forEach(newClient => {
            const existingClient = this.masterData.clients.find(c => c.name.toLowerCase() === newClient.name.trim().toLowerCase());
            let resolvedGroupId = undefined;
            if (newClient.groupId) {
              resolvedGroupId = groupMap[newClient.groupId];
            }

            if (existingClient) {
              clientMap[newClient.id] = existingClient.id;
              if (!existingClient.groupId && resolvedGroupId) {
                existingClient.groupId = resolvedGroupId;
              }
            } else {
              const newId = this.generateId(this.masterData.clients);
              clientMap[newClient.id] = newId;
              this.masterData.clients.push({ ...newClient, id: newId, groupId: resolvedGroupId });
            }
          });

          // 2. Objects
          const objectMap = {};
          newData.objects.forEach(newObj => {
            const newClientId = clientMap[newObj.clientId];
            if (!newClientId) return;

            const existingObj = this.masterData.objects.find(o =>
              o.clientId === newClientId &&
              o.name.toLowerCase() === newObj.name.trim().toLowerCase()
            );

            if (existingObj) {
              objectMap[newObj.id] = existingObj.id;
            } else {
              const newId = this.generateId(this.masterData.objects);
              objectMap[newObj.id] = newId;
              this.masterData.objects.push({ ...newObj, id: newId, clientId: newClientId });
            }
          });

          // 3. Stations
          newData.stations.forEach(newStation => {
            const newObjectId = objectMap[newStation.objectId];
            if (!newObjectId) return;

            const newId = this.generateId(this.masterData.stations);
            this.masterData.stations.push({
              ...newStation,
              id: newId,
              objectId: newObjectId
            });
          });
        },

        generateId(collection) {
          if (collection.length === 0) return 1;
          return Math.max(...collection.map(i => i.id || 0)) + 1;
        },

        // --- Groups ---
        addGroup() {
          const name = prompt("Enter Group Name:");
          if (name) {
            const newId = this.generateId(this.masterData.groups);
            this.masterData.groups.push({ id: newId, name, color: 'blue' });
          }
        },

        updateClientGroup(clientId, groupIdStr) {
          const client = this.masterData.clients.find(c => c.id === clientId);
          if (client) {
            if (client.groupId === -1) client.groupId = undefined;
          }
        },

        cycleGroupColor(group) {
          const colors = ['blue', 'red', 'green', 'yellow', 'purple', 'orange', 'gray', 'slate'];
          const idx = colors.indexOf(group.color || 'blue');
          const nextIdx = (idx + 1) % colors.length;
          group.color = colors[nextIdx];
        },

        // --- Editing ---
        startRename(type, id, currentName) {
          this.editingId = `${type}-${id}`;
          this.editName = currentName;
        },

        cancelRename() {
          this.editingId = null;
          this.editName = "";
        },

        saveRename(type, id) {
          if (!this.editName.trim()) return;

          let collection;
          if (type === 'client') collection = this.masterData.clients;
          if (type === 'object') collection = this.masterData.objects;
          if (type === 'station') collection = this.masterData.stations;
          if (type === 'group') collection = this.masterData.groups;

          const item = collection.find(i => i.id === id);
          if (item) {
            item.name = this.editName.trim();
          }
          this.editingId = null;
        },

        // --- Bulk Actions ---
        toggleSelection(type, id) {
          const key = `${type}-${id}`;
          if (this.selectedItems.has(key)) {
            this.selectedItems.delete(key);
          } else {
            this.selectedItems.add(key);
          }
          this.selectedItems = new Set(this.selectedItems); // Refresh reactivity
        },

        bulkDelete() {
          if (!confirm(`Delete ${this.selectedItems.size} selected items? This cannot be undone.`)) return;

          this.selectedItems.forEach(key => {
            const [type, idStr] = key.split("-");
            const id = parseInt(idStr);

            if (type === 'station') {
              this.masterData.stations = this.masterData.stations.filter(s => s.id !== id);
            } else if (type === 'object') {
              // Deleting object deletes its stations
              this.masterData.objects = this.masterData.objects.filter(o => o.id !== id);
              this.masterData.stations = this.masterData.stations.filter(s => s.objectId !== id);
            } else if (type === 'client') {
              // Deleting client deletes objects
              this.masterData.clients = this.masterData.clients.filter(c => c.id !== id);
              const objectIds = this.masterData.objects.filter(o => o.clientId === id).map(o => o.id);
              this.masterData.objects = this.masterData.objects.filter(o => o.clientId !== id);
              this.masterData.stations = this.masterData.stations.filter(s => !objectIds.includes(s.objectId));
            }
          });
          this.selectedItems.clear();
        },

        performBulkMove(targetValue) {
          if (!targetValue) return;
          const [targetType, targetIdStr] = targetValue.split("-");
          const targetId = parseInt(targetIdStr);

          let movedCount = 0;

          this.selectedItems.forEach(key => {
            const [type, idStr] = key.split("-");
            const id = parseInt(idStr);

            // 1. Moving Objects to Client
            if (type === 'object' && targetType === 'client') {
              const obj = this.masterData.objects.find(o => o.id === id);
              if (obj && obj.clientId !== targetId) {
                obj.clientId = targetId;
                movedCount++;
              }
            }

            // 2. Moving Clients to Group
            if (type === 'client' && targetType === 'group') {
              const client = this.masterData.clients.find(c => c.id === id);
              if (client) {
                if (targetValue === 'group-remove') {
                  client.groupId = undefined;
                } else if (client.groupId !== targetId) {
                  client.groupId = targetId;
                }
                movedCount++;
              }
            }

            // 3. Moving Stations... (Not implemented in top dropdown yet, usually dragndrop or detailed view)
            // But if we wanted to support it, we'd need expanded target options.
            // For now, let's assume Stations are moved via drag/drop or individual select. 
            // Wait, the dropdown mainly shows Clients/Groups. 
            // If a user selects stations, they can't move to "Client". They need "Object".
            // Let's rely on specific moves for now or keep it simple.
          });

          if (movedCount > 0) {
            // alert(`Moved ${movedCount} items.`);
            this.selectedItems.clear();
          }
        },

        deleteItem(type, id) {
          if (!confirm("Are you sure? This will delete the item and all children.")) return;

          if (type === 'station') {
            this.masterData.stations = this.masterData.stations.filter(s => s.id !== id);
          } else if (type === 'object') {
            this.masterData.objects = this.masterData.objects.filter(o => o.id !== id);
            this.masterData.stations = this.masterData.stations.filter(s => s.objectId !== id);
          } else if (type === 'client') {
            this.masterData.clients = this.masterData.clients.filter(c => c.id !== id);
            const objectsToDelete = this.masterData.objects.filter(o => o.clientId === id).map(o => o.id);
            this.masterData.objects = this.masterData.objects.filter(o => o.clientId !== id);
            this.masterData.stations = this.masterData.stations.filter(s => !objectsToDelete.includes(s.objectId));
          } else if (type === 'group') {
            this.masterData.groups = this.masterData.groups.filter(g => g.id !== id);
            this.masterData.clients.forEach(c => {
              if (c.groupId === id) c.groupId = undefined;
            });
          }
        },

        moveStation(stationId, newObjectId) {
          const station = this.masterData.stations.find(s => s.id === stationId);
          if (station) {
            station.objectId = parseInt(newObjectId);
          }
        },

        // --- DnD (Beta) ---
        dragStart(e, station) {
        },

        // --- Export ---
        exportData() {
          const dataStr = JSON.stringify(this.masterData, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const date = new Date().toISOString().slice(0, 10);
          const link = document.createElement('a');
          link.download = `svakisto_composite_${date}.json`;
          link.href = url;
          link.click();
        }
      }
    }
  </script>
</body>

</html>